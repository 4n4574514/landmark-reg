<div id="template_viewer">
  <!--
  // for reduced-resolution dataset. TODO: get them from a service
      var xdim=(((6572+1)>>1)+1)>>1;
      var zdim=(((7404+1)>>1)+1)>>1;
      var ydim=(((5711+1)>>1)+1)>>1;

      Oslo-hosted BigBrain:
          base-url="http://www.nesys.uio.no/CDPTest/data"
          size="[1643, 1428, 1851]"
          level-offset="2"
          max-level="3"
    -->
  <zoomer cursor="$ctrl.template_cursor"
          base-url="/data/BigBrain-160um"
          size="[822, 926, 714]"
          voxel-size="[0.16933333333333334, 0.160, 0.16933333333333334]"
          level-offset="0"
          max-level="2"
          tile-size="256"
          on-cursor-update="$ctrl.updateTemplateCursor(cursor);"/>

  <div class="control_panel"> <!-- TODO decide in which CSS this class should go -->
    <p>Template: {{$ctrl.template_description}}</p>
    <hr/>
    <p>Template image cursor: <coordinates coords="$ctrl.template_cursor"/></p>
    <p>Incoming image cursor: <coordinates coords="$ctrl.incoming_cursor"/></p>
    <hr/>
    <h4>Landmark pairs</h4>
    <landmark-list on-update="$ctrl.landmark_pairs = landmark_pairs"
                   incoming-cursor="$ctrl.incoming_cursor"
                   template-cursor="$ctrl.template_cursor"
                   go-to-landmark-pair="$ctrl.goToLandmarkPair(pair)"/>
  </div>
</div>
<div id="incoming_viewer">
  <zoomer cursor="$ctrl.incoming_cursor"
          base-url="/data/B20_stn_l"
          size="[1002, 820, 489]"
          voxel-size="[0.016, 0.016, 0.020]"
          level-offset="0"
          max-level="3"
          tile-size="256"
          on-cursor-update="$ctrl.updateIncomingCursor(cursor);"/>

  <div class="control_panel">
    <h4>Incoming image</h4>
    <!-- TODO insert here a reference to the incoming image's metadata
         (e.g. link to dataset page) -->
    <label for="incoming_voxel_size"> Voxel size:</label>
    <div class="input-group input-group-sm">
      <input class="form-control" type="text" readonly="readonly"/>
      <span class="input-group-btn">
        <button class="btn btn-default">
          Editâ€¦
        </button>
      </span>
    </div>
    <hr/>
    <h4>Registration control</h4>
    <div class="form-inline">
      <div class="form-group">
        <label>
          Transformation type
          <select ng-model="$ctrl.transformation_type" class="form-control">
            <option value="translation">Translation</option>
            <option value="rigid">Rigid</option>
            <option value="similarity">Similarity</option>
            <option value="affine">Affine</option>
          </select>
        </label>
      </div>
      <button type="button" ng-click="$ctrl.performRegistration()"
              class="btn btn-primary btn-block"
              ng-disabled="!$ctrl.readyToTransform()">
        Compute transformation
      </button>
    </div>
    <hr/>
    <div class="bg-danger" ng-show="$ctrl.registration_result.error">
      <p>Error: {{$ctrl.registration_result.error}}</p>
    </div>
    <div ng-show="$ctrl.transformationAvailable()">
      <p>Estimated transformation matrix</p>
      <transformation-matrix matrix="$ctrl.registration_result.transformation_matrix"/>
    </div>
    <p>
      <label>
        <input ng-model="$ctrl.synchronize_cursors" type="checkbox"
               ng-disabled="!$ctrl.transformationAvailable()"/>
        Synchronize cursors
      </label>
    </p>
    <a class="btn btn-primary" ng-disabled="!$ctrl.transformationAvailable()"
       target="_blank"
       href="http://localhost:8080/#!{%27layers%27:{%27template%27:{%27type%27:%27image%27_%27source%27:%27precomputed://http://localhost:8080/precomputed/BigBrainRelease.2015/8bit%27}_%27incoming%27:{%27type%27:%27image%27_%27source%27:%27precomputed://http://localhost:8080/precomputed/B20_stn_l/raw%27_%27shader%27:%27void%20main()%20{\n%20%20emitRGB(vec3(0.,%20toNormalized(getDataValue()),%200.));\n}\n%27_%27transform%27:[[{{$ctrl.registration_result.transformation_matrix[0][0]}}_{{$ctrl.registration_result.transformation_matrix[0][1]}}_{{$ctrl.registration_result.transformation_matrix[0][2]}}_{{$ctrl.registration_result.transformation_matrix[0][3] * 1e6}}]_[{{$ctrl.registration_result.transformation_matrix[1][0]}}_{{$ctrl.registration_result.transformation_matrix[1][1]}}_{{$ctrl.registration_result.transformation_matrix[1][2]}}_{{$ctrl.registration_result.transformation_matrix[1][3] * 1e6}}]_[{{$ctrl.registration_result.transformation_matrix[2][0]}}_{{$ctrl.registration_result.transformation_matrix[2][1]}}_{{$ctrl.registration_result.transformation_matrix[2][2]}}_{{$ctrl.registration_result.transformation_matrix[2][3] * 1e6}}]_[{{$ctrl.registration_result.transformation_matrix[3][0]}}_{{$ctrl.registration_result.transformation_matrix[3][1]}}_{{$ctrl.registration_result.transformation_matrix[3][2]}}_{{$ctrl.registration_result.transformation_matrix[3][3]}}]]}}}">
      Display result
    </a>
  </div>
</div>
